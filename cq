#!/usr/bin/env bash
# Code Query (cq) - High-signal code analysis for Claude Code and OpenAI Codex
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$ROOT"

PY="${CQ_PYTHON:-}"
if [[ -z "${PY}" ]]; then
    if [[ -x "${ROOT}/.venv/bin/python" ]]; then
        PY="${ROOT}/.venv/bin/python"
    else
        PY="$(command -v python3 || command -v python)"
    fi
fi

# Normalize global options so they work regardless of position.
rest=()
args=("$@")
i=0
while [[ $i -lt ${#args[@]} ]]; do
    arg="${args[$i]}"
    case "$arg" in
        --root|--verbose|-v|--format|--artifact-dir|--config)
            i=$((i + 1))
            if [[ $i -lt ${#args[@]} ]]; then
                value="${args[$i]}"
                case "$arg" in
                    --root) export CQ_ROOT="$value" ;;
                    --verbose|-v) export CQ_VERBOSE="$value" ;;
                    --format) export CQ_FORMAT="$value" ;;
                    --artifact-dir) export CQ_ARTIFACT_DIR="$value" ;;
                    --config) export CQ_CONFIG="$value" ;;
                esac
            fi
            ;;
        --root=*|--verbose=*|--format=*|--artifact-dir=*|--config=*)
            key="${arg%%=*}"
            value="${arg#*=}"
            case "$key" in
                --root) export CQ_ROOT="$value" ;;
                --verbose) export CQ_VERBOSE="$value" ;;
                --format) export CQ_FORMAT="$value" ;;
                --artifact-dir) export CQ_ARTIFACT_DIR="$value" ;;
                --config) export CQ_CONFIG="$value" ;;
            esac
            ;;
        --save-artifact|--no-save-artifact|--use-config|--no-config)
            case "$arg" in
                --save-artifact) export CQ_SAVE_ARTIFACT="1" ;;
                --no-save-artifact) export CQ_SAVE_ARTIFACT="0" ;;
                --use-config) export CQ_USE_CONFIG="1" ;;
                --no-config) export CQ_USE_CONFIG="0" ;;
            esac
            ;;
        *)
            rest+=("$arg")
            ;;
    esac
    i=$((i + 1))
done

exec "${PY}" -m tools.cq.cli "${rest[@]}"
