"""Schema specification models and adapters."""

from __future__ import annotations

import importlib
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from schema_spec.dataset_spec import (
        SCHEMA_EVOLUTION_PRESETS,
        ArrowValidationOptions,
        ContractCatalogSpec,
        ContractSpec,
        DatasetKind,
        DatasetOpenSpec,
        DatasetSpec,
        DedupeSpecSpec,
        DeltaScanOptions,
        DeltaSchemaPolicy,
        DeltaWritePolicy,
        SortKeySpec,
        TableSchemaContract,
        TableSpecConstraints,
        ValidationPolicySpec,
        VirtualFieldSpec,
        dataset_spec_contract,
        dataset_spec_contract_spec_or_default,
        dataset_spec_datafusion_scan,
        dataset_spec_delta_cdf_policy,
        dataset_spec_delta_constraints,
        dataset_spec_delta_feature_gate,
        dataset_spec_delta_maintenance_policy,
        dataset_spec_delta_scan,
        dataset_spec_delta_schema_policy,
        dataset_spec_delta_write_policy,
        dataset_spec_encoding_policy,
        dataset_spec_from_contract,
        dataset_spec_from_dataset,
        dataset_spec_from_path,
        dataset_spec_from_schema,
        dataset_spec_name,
        dataset_spec_ordering,
        dataset_spec_query,
        dataset_spec_resolved_view_specs,
        dataset_spec_schema,
        dataset_spec_strict_schema_validation,
        dataset_spec_with_delta_maintenance,
        dataset_table_column_defaults,
        dataset_table_constraints,
        dataset_table_ddl_fingerprint,
        dataset_table_definition,
        dataset_table_logical_plan,
        ddl_fingerprint_from_definition,
        make_contract_spec,
        make_dataset_spec,
        make_table_spec,
        resolve_schema_evolution_spec,
        validate_arrow_table,
    )
    from schema_spec.evidence_metadata import (
        EVIDENCE_METADATA_FIELDS,
        evidence_metadata_bundle,
        evidence_metadata_defaults,
        evidence_metadata_field_names,
        evidence_struct_type,
    )
    from schema_spec.field_spec import FieldSpec
    from schema_spec.specs import (
        DICT_STRING,
        ENCODING_DICTIONARY,
        ENCODING_META,
        KEY_FIELDS_META,
        PROVENANCE_COLS,
        PROVENANCE_SOURCE_FIELDS,
        REQUIRED_NON_NULL_META,
        SCHEMA_META_NAME,
        SCHEMA_META_VERSION,
        DerivedFieldSpec,
        FieldBundle,
        NestedFieldSpec,
        TableSchemaSpec,
        call_span_bundle,
        dict_field,
        file_identity_bundle,
        list_view_type,
        provenance_bundle,
        schema_metadata,
        schema_metadata_for_spec,
        scip_range_bundle,
        span_bundle,
    )
    from schema_spec.view_specs import ViewSchemaMismatchError, ViewSpec

_EXPORT_MAP: dict[str, tuple[str, str]] = {
    # Evidence metadata canonical fields and helpers
    "EVIDENCE_METADATA_FIELDS": ("schema_spec.evidence_metadata", "EVIDENCE_METADATA_FIELDS"),
    "evidence_metadata_bundle": ("schema_spec.evidence_metadata", "evidence_metadata_bundle"),
    "evidence_metadata_defaults": ("schema_spec.evidence_metadata", "evidence_metadata_defaults"),
    "evidence_metadata_field_names": (
        "schema_spec.evidence_metadata",
        "evidence_metadata_field_names",
    ),
    "evidence_struct_type": ("schema_spec.evidence_metadata", "evidence_struct_type"),
    # Schema spec exports
    "DICT_STRING": ("schema_spec.specs", "DICT_STRING"),
    "ENCODING_DICTIONARY": ("schema_spec.specs", "ENCODING_DICTIONARY"),
    "ENCODING_META": ("schema_spec.specs", "ENCODING_META"),
    "SCHEMA_EVOLUTION_PRESETS": ("schema_spec.dataset_spec", "SCHEMA_EVOLUTION_PRESETS"),
    "KEY_FIELDS_META": ("schema_spec.specs", "KEY_FIELDS_META"),
    "PROVENANCE_COLS": ("schema_spec.specs", "PROVENANCE_COLS"),
    "PROVENANCE_SOURCE_FIELDS": ("schema_spec.specs", "PROVENANCE_SOURCE_FIELDS"),
    "REQUIRED_NON_NULL_META": ("schema_spec.specs", "REQUIRED_NON_NULL_META"),
    "SCHEMA_META_NAME": ("schema_spec.specs", "SCHEMA_META_NAME"),
    "SCHEMA_META_VERSION": ("schema_spec.specs", "SCHEMA_META_VERSION"),
    "FieldSpec": ("schema_spec.field_spec", "FieldSpec"),
    "ArrowValidationOptions": ("schema_spec.dataset_spec", "ArrowValidationOptions"),
    "ValidationPolicySpec": ("schema_spec.dataset_spec", "ValidationPolicySpec"),
    "ContractCatalogSpec": ("schema_spec.dataset_spec", "ContractCatalogSpec"),
    "ContractSpec": ("schema_spec.dataset_spec", "ContractSpec"),
    "DatasetKind": ("schema_spec.dataset_spec", "DatasetKind"),
    "DatasetOpenSpec": ("schema_spec.dataset_spec", "DatasetOpenSpec"),
    "DatasetSpec": ("schema_spec.dataset_spec", "DatasetSpec"),
    "DedupeSpecSpec": ("schema_spec.dataset_spec", "DedupeSpecSpec"),
    "DeltaScanOptions": ("schema_spec.dataset_spec", "DeltaScanOptions"),
    "DeltaSchemaPolicy": ("schema_spec.dataset_spec", "DeltaSchemaPolicy"),
    "DeltaWritePolicy": ("schema_spec.dataset_spec", "DeltaWritePolicy"),
    "DerivedFieldSpec": ("schema_spec.specs", "DerivedFieldSpec"),
    "FieldBundle": ("schema_spec.specs", "FieldBundle"),
    "NestedFieldSpec": ("schema_spec.specs", "NestedFieldSpec"),
    "SortKeySpec": ("schema_spec.dataset_spec", "SortKeySpec"),
    "TableSchemaSpec": ("schema_spec.specs", "TableSchemaSpec"),
    "TableSpecConstraints": ("schema_spec.dataset_spec", "TableSpecConstraints"),
    "VirtualFieldSpec": ("schema_spec.dataset_spec", "VirtualFieldSpec"),
    "ViewSchemaMismatchError": ("schema_spec.view_specs", "ViewSchemaMismatchError"),
    "ViewSpec": ("schema_spec.view_specs", "ViewSpec"),
    "call_span_bundle": ("schema_spec.specs", "call_span_bundle"),
    "dataset_spec_from_contract": ("schema_spec.dataset_spec", "dataset_spec_from_contract"),
    "dataset_spec_from_dataset": ("schema_spec.dataset_spec", "dataset_spec_from_dataset"),
    "dataset_spec_from_path": ("schema_spec.dataset_spec", "dataset_spec_from_path"),
    "dataset_spec_from_schema": ("schema_spec.dataset_spec", "dataset_spec_from_schema"),
    "dataset_spec_contract": ("schema_spec.dataset_spec", "dataset_spec_contract"),
    "dataset_spec_contract_spec_or_default": (
        "schema_spec.dataset_spec",
        "dataset_spec_contract_spec_or_default",
    ),
    "dataset_spec_datafusion_scan": ("schema_spec.dataset_spec", "dataset_spec_datafusion_scan"),
    "dataset_spec_delta_cdf_policy": ("schema_spec.dataset_spec", "dataset_spec_delta_cdf_policy"),
    "dataset_spec_delta_constraints": (
        "schema_spec.dataset_spec",
        "dataset_spec_delta_constraints",
    ),
    "dataset_spec_delta_feature_gate": (
        "schema_spec.dataset_spec",
        "dataset_spec_delta_feature_gate",
    ),
    "dataset_spec_delta_maintenance_policy": (
        "schema_spec.dataset_spec",
        "dataset_spec_delta_maintenance_policy",
    ),
    "dataset_spec_delta_scan": ("schema_spec.dataset_spec", "dataset_spec_delta_scan"),
    "dataset_spec_delta_schema_policy": (
        "schema_spec.dataset_spec",
        "dataset_spec_delta_schema_policy",
    ),
    "dataset_spec_delta_write_policy": (
        "schema_spec.dataset_spec",
        "dataset_spec_delta_write_policy",
    ),
    "dataset_spec_encoding_policy": ("schema_spec.dataset_spec", "dataset_spec_encoding_policy"),
    "dataset_spec_name": ("schema_spec.dataset_spec", "dataset_spec_name"),
    "dataset_spec_ordering": ("schema_spec.dataset_spec", "dataset_spec_ordering"),
    "dataset_spec_query": ("schema_spec.dataset_spec", "dataset_spec_query"),
    "dataset_spec_resolved_view_specs": (
        "schema_spec.dataset_spec",
        "dataset_spec_resolved_view_specs",
    ),
    "dataset_spec_schema": ("schema_spec.dataset_spec", "dataset_spec_schema"),
    "dataset_spec_strict_schema_validation": (
        "schema_spec.dataset_spec",
        "dataset_spec_strict_schema_validation",
    ),
    "dataset_spec_with_delta_maintenance": (
        "schema_spec.dataset_spec",
        "dataset_spec_with_delta_maintenance",
    ),
    "dataset_table_column_defaults": ("schema_spec.dataset_spec", "dataset_table_column_defaults"),
    "dataset_table_constraints": ("schema_spec.dataset_spec", "dataset_table_constraints"),
    "dataset_table_definition": ("schema_spec.dataset_spec", "dataset_table_definition"),
    "dataset_table_ddl_fingerprint": ("schema_spec.dataset_spec", "dataset_table_ddl_fingerprint"),
    "dataset_table_logical_plan": ("schema_spec.dataset_spec", "dataset_table_logical_plan"),
    "ddl_fingerprint_from_definition": (
        "schema_spec.dataset_spec",
        "ddl_fingerprint_from_definition",
    ),
    "dict_field": ("schema_spec.specs", "dict_field"),
    "file_identity_bundle": ("schema_spec.specs", "file_identity_bundle"),
    "list_view_type": ("schema_spec.specs", "list_view_type"),
    "make_contract_spec": ("schema_spec.dataset_spec", "make_contract_spec"),
    "make_dataset_spec": ("schema_spec.dataset_spec", "make_dataset_spec"),
    "make_table_spec": ("schema_spec.dataset_spec", "make_table_spec"),
    "resolve_schema_evolution_spec": ("schema_spec.dataset_spec", "resolve_schema_evolution_spec"),
    "provenance_bundle": ("schema_spec.specs", "provenance_bundle"),
    "schema_metadata": ("schema_spec.specs", "schema_metadata"),
    "schema_metadata_for_spec": ("schema_spec.specs", "schema_metadata_for_spec"),
    "scip_range_bundle": ("schema_spec.specs", "scip_range_bundle"),
    "span_bundle": ("schema_spec.specs", "span_bundle"),
    "TableSchemaContract": ("schema_spec.dataset_spec", "TableSchemaContract"),
    "validate_arrow_table": ("schema_spec.dataset_spec", "validate_arrow_table"),
}


def __getattr__(name: str) -> object:
    target = _EXPORT_MAP.get(name)
    if target is None:
        msg = f"module {__name__!r} has no attribute {name!r}"
        raise AttributeError(msg)
    module_path, attr_name = target
    module = importlib.import_module(module_path)
    return getattr(module, attr_name)


def __dir__() -> list[str]:
    return sorted(list(globals()) + list(_EXPORT_MAP))


__all__ = [
    "DICT_STRING",
    "ENCODING_DICTIONARY",
    "ENCODING_META",
    "EVIDENCE_METADATA_FIELDS",
    "KEY_FIELDS_META",
    "PROVENANCE_COLS",
    "PROVENANCE_SOURCE_FIELDS",
    "REQUIRED_NON_NULL_META",
    "SCHEMA_EVOLUTION_PRESETS",
    "SCHEMA_META_NAME",
    "SCHEMA_META_VERSION",
    "ArrowValidationOptions",
    "ContractCatalogSpec",
    "ContractSpec",
    "DatasetKind",
    "DatasetOpenSpec",
    "DatasetSpec",
    "DedupeSpecSpec",
    "DeltaScanOptions",
    "DeltaSchemaPolicy",
    "DeltaWritePolicy",
    "DerivedFieldSpec",
    "FieldBundle",
    "FieldSpec",
    "NestedFieldSpec",
    "SortKeySpec",
    "TableSchemaContract",
    "TableSchemaSpec",
    "TableSpecConstraints",
    "ValidationPolicySpec",
    "ViewSchemaMismatchError",
    "ViewSpec",
    "VirtualFieldSpec",
    "call_span_bundle",
    "dataset_spec_contract",
    "dataset_spec_contract_spec_or_default",
    "dataset_spec_datafusion_scan",
    "dataset_spec_delta_cdf_policy",
    "dataset_spec_delta_constraints",
    "dataset_spec_delta_feature_gate",
    "dataset_spec_delta_maintenance_policy",
    "dataset_spec_delta_scan",
    "dataset_spec_delta_schema_policy",
    "dataset_spec_delta_write_policy",
    "dataset_spec_encoding_policy",
    "dataset_spec_from_contract",
    "dataset_spec_from_dataset",
    "dataset_spec_from_path",
    "dataset_spec_from_schema",
    "dataset_spec_name",
    "dataset_spec_ordering",
    "dataset_spec_query",
    "dataset_spec_resolved_view_specs",
    "dataset_spec_schema",
    "dataset_spec_strict_schema_validation",
    "dataset_spec_with_delta_maintenance",
    "dataset_table_column_defaults",
    "dataset_table_constraints",
    "dataset_table_ddl_fingerprint",
    "dataset_table_definition",
    "dataset_table_logical_plan",
    "ddl_fingerprint_from_definition",
    "dict_field",
    "evidence_metadata_bundle",
    "evidence_metadata_defaults",
    "evidence_metadata_field_names",
    "evidence_struct_type",
    "file_identity_bundle",
    "list_view_type",
    "make_contract_spec",
    "make_dataset_spec",
    "make_table_spec",
    "provenance_bundle",
    "resolve_schema_evolution_spec",
    "schema_metadata",
    "schema_metadata_for_spec",
    "scip_range_bundle",
    "span_bundle",
    "validate_arrow_table",
]
