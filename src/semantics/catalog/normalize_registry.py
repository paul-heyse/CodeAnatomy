"""Registry of normalize layer datasets."""

from __future__ import annotations

from typing import Final

from semantics.catalog.dataset_rows import SemanticDatasetRow

NORMALIZE_SCHEMA_VERSION: Final[int] = 1

NORMALIZE_DATASETS: Final[tuple[SemanticDatasetRow, ...]] = (
    SemanticDatasetRow(
        name="normalize_evidence",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=(
            "span_id",
            "evidence_family",
            "source",
            "role",
            "confidence",
            "ambiguity_group_id",
            "task_name",
        ),
        category="semantic",
        supports_cdf=True,
        join_keys=("span_id", "task_name"),
        template="normalize_evidence",
        register_view=False,
    ),
    SemanticDatasetRow(
        name="type_exprs_norm",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=(
            "type_expr_id",
            "owner_def_id",
            "param_name",
            "expr_kind",
            "expr_role",
            "expr_text",
            "type_repr",
            "type_id",
        ),
        category="semantic",
        supports_cdf=True,
        join_keys=("type_expr_id",),
        template="normalize_cst",
        view_builder="type_exprs_df_builder",
    ),
    SemanticDatasetRow(
        name="type_nodes",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=(),
        fields=("type_id", "type_repr", "type_form", "origin"),
        category="semantic",
        supports_cdf=True,
        join_keys=("type_id",),
        template="normalize_type",
        view_builder="type_nodes_df_builder",
    ),
    SemanticDatasetRow(
        name="py_bc_blocks_norm",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=("block_id", "code_unit_id", "start_offset", "end_offset", "kind"),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("code_unit_id", "block_id"),
        template="normalize_bytecode",
        view_builder="cfg_blocks_df_builder",
    ),
    SemanticDatasetRow(
        name="py_bc_cfg_edges_norm",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity",),
        fields=(
            "edge_id",
            "code_unit_id",
            "src_block_id",
            "dst_block_id",
            "kind",
            "cond_instr_id",
            "exc_index",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("code_unit_id", "edge_id"),
        template="normalize_bytecode",
        view_builder="cfg_edges_df_builder",
    ),
    SemanticDatasetRow(
        name="py_bc_instr_norm",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity",),
        fields=(
            "instr_id",
            "code_unit_id",
            "offset",
            "opname",
            "arg",
            "arg_repr",
            "is_jump_target",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("code_unit_id", "instr_id"),
        template="normalize_bytecode",
        view_builder="instructions_df_builder",
    ),
    SemanticDatasetRow(
        name="py_bc_exceptions_norm",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity",),
        fields=(
            "handler_id",
            "code_unit_id",
            "kind",
            "start_offset",
            "end_offset",
            "target_offset",
            "stack_depth",
            "stack_top",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("code_unit_id", "handler_id"),
        template="normalize_bytecode",
        view_builder="exception_handlers_df_builder",
    ),
    SemanticDatasetRow(
        name="symtable_scopes",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=(),
        fields=(
            "block_id",
            "parent_block_id",
            "block_type",
            "is_meta_scope",
            "name",
            "lineno1",
            "span_hint",
            "scope_id",
            "scope_local_id",
            "scope_type_value",
            "qualpath",
            "function_partitions",
            "class_methods",
            "symbols",
            "attrs",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("scope_id",),
        template=None,
        view_builder=None,
        register_view=False,
        source_dataset="symtable_scopes",
        role="input",
    ),
    SemanticDatasetRow(
        name="symtable_symbols",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=(),
        fields=(
            "block_id",
            "scope_id",
            "name",
            "sym_symbol_id",
            "flags",
            "namespace_count",
            "namespace_block_ids",
            "attrs",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("scope_id", "name"),
        template=None,
        view_builder=None,
        register_view=False,
        source_dataset="symtable_symbols",
        role="input",
    ),
    SemanticDatasetRow(
        name="symtable_bindings",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=(
            "scope_id",
            "scope_type",
            "scope_name",
            "scope_lineno",
            "name",
            "binding_id",
            "binding_kind",
            "declared_here",
            "referenced_here",
            "assigned_here",
            "annotated_here",
            "is_imported",
            "is_parameter",
            "is_free",
            "is_nonlocal",
            "is_global",
            "is_declared_global",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("binding_id",),
        template="normalize_symtable",
        view_builder="symtable_bindings_df_builder",
    ),
    SemanticDatasetRow(
        name="symtable_def_sites",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=(
            "scope_id",
            "binding_id",
            "name",
            "def_id",
            "bstart",
            "bend",
            "def_site_kind",
            "anchor_confidence",
            "anchor_reason",
            "ambiguity_group_id",
            "def_site_id",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("def_site_id",),
        template="normalize_symtable",
        view_builder="symtable_def_sites_df_builder",
    ),
    SemanticDatasetRow(
        name="symtable_use_sites",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=("file_identity", "span"),
        fields=(
            "scope_id",
            "binding_id",
            "name",
            "ref_id",
            "bstart",
            "bend",
            "use_kind",
            "anchor_confidence",
            "anchor_reason",
            "ambiguity_group_id",
            "use_site_id",
        ),
        category="analysis",
        supports_cdf=True,
        partition_cols=("path",),
        join_keys=("use_site_id",),
        template="normalize_symtable",
        view_builder="symtable_use_sites_df_builder",
    ),
    SemanticDatasetRow(
        name="scip_diagnostics",
        version=NORMALIZE_SCHEMA_VERSION,
        bundles=(),
        fields=(
            "index_id",
            "index_path",
            "document_id",
            "severity",
            "message",
            "source",
            "tags",
            "start_line",
            "start_char",
            "end_line",
            "end_char",
            "line_base",
            "col_unit",
            "end_exclusive",
        ),
        category="diagnostic",
        supports_cdf=True,
        join_keys=("index_id", "document_id", "start_line", "start_char"),
        template=None,
        view_builder=None,
        register_view=False,
        source_dataset="scip_diagnostics",
        role="input",
    ),
)

__all__ = ["NORMALIZE_DATASETS", "NORMALIZE_SCHEMA_VERSION"]
